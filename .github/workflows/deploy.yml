# FILE: .github/workflows/deploy.yml
# --- VERSION 7 (DEFINITIVE & COMPLETE FIX) ---
# This version includes all previous fixes and adds the crucial step of granting
# the Firebase Hosting Service Agent the 'serviceAccountTokenCreator' role on the
# invoker SA. This allows Firebase Hosting to impersonate the invoker and generate
# the necessary ID tokens to call the private Cloud Run service.

name: Deploy Project

on:
  push:
    branches: [ "dev", "main" ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  GCP_REGION: ${{ secrets.GCP_REGION || 'europe-west1' }}
  AR_REPO: "wizbi"
  IMAGE_NAME: ${{ github.event.repository.name }}

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.DEPLOYER_SA }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker authentication
        run: gcloud auth configure-docker "${{ env.GCP_REGION }}-docker.pkg.dev"

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Decide Target Service and Hosting Site
        id: target
        run: |
          if [[ "${GITHUB_REF_NAME}" == "dev" ]]; then
            echo "service_id=${{ github.event.repository.name }}-service-qa" >> $GITHUB_OUTPUT
            echo "hosting_site=${{ github.event.repository.name }}-qa" >> $GITHUB_OUTPUT
          else
            echo "service_id=${{ github.event.repository.name }}-service" >> $GITHUB_OUTPUT
            echo "hosting_site=${{ github.event.repository.name }}" >> $GITHUB_OUTPUT
          fi

      - name: Deploy and Secure Cloud Run Service
        id: deploy-service
        run: |
          DEPLOYER_SA_EMAIL="${{ secrets.DEPLOYER_SA }}"
          gcloud run deploy "${{ steps.target.outputs.service_id }}" \
            --image "${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --region "${{ env.GCP_REGION }}" \
            --service-account "${DEPLOYER_SA_EMAIL}" \
            --no-allow-unauthenticated \
            --project "${{ secrets.GCP_PROJECT_ID }}" \
            --update-env-vars "GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}"

      - name: Set Invoker IAM Policy on Cloud Run Service
        run: |
          INVOKER_SA_EMAIL="firebase-hosting-invoker@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com"
          SERVICE_ID="${{ steps.target.outputs.service_id }}"
          echo "Setting invoker policy for service ${SERVICE_ID}..."
          gcloud run services add-iam-policy-binding "${SERVICE_ID}" \
            --region "${{ env.GCP_REGION }}" \
            --member="serviceAccount:${INVOKER_SA_EMAIL}" \
            --role="roles/run.invoker" \
            --project "${{ secrets.GCP_PROJECT_ID }}"
            
      # --- THE CRITICAL MISSING PIECE ---
      - name: Grant Firebase permission to impersonate Invoker SA
        run: |
          PROJECT_NUMBER=$(gcloud projects describe ${{ secrets.GCP_PROJECT_ID }} --format="value(projectNumber)")
          FIREBASE_SA="service-${PROJECT_NUMBER}@gcp-sa-firebase.iam.gserviceaccount.com"
          INVOKER_SA="firebase-hosting-invoker@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com"
          echo "Granting Firebase SA [${FIREBASE_SA}] permission to impersonate Invoker SA [${INVOKER_SA}]"
          gcloud iam service-accounts add-iam-policy-binding "${INVOKER_SA}" \
            --member="serviceAccount:${FIREBASE_SA}" \
            --role="roles/iam.serviceAccountTokenCreator" \
            --project "${{ secrets.GCP_PROJECT_ID }}"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting
        run: |
          firebase deploy \
            --only hosting:${{ steps.target.outputs.hosting_site }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --non-interactive

