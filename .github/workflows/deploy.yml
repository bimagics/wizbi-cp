name: Deploy (Cloud Run)

on:
  push:
    branches: [ "dev", "main" ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      WIF_PROVIDER: ${{ secrets.WIF_PROVIDER }}
      DEPLOYER_SA: ${{ secrets.DEPLOYER_SA }}
      AR_REPO: wizbi
      IMAGE_NAME: cp-unified

    steps:
      - uses: actions/checkout@v4

      - name: Auth to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.DEPLOYER_SA }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "${{ env.REGION }}-docker.pkg.dev" -q

      - name: Build image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:latest"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" .

      - name: Push image
        run: docker push "$IMAGE"

      - name: Decide target (QA vs PROD)
        id: cfg
        run: |
          BRANCH="${GITHUB_REF##*/}"
          if [[ "$BRANCH" == "dev" ]]; then
            echo "service=cp-unified-qa"                          >> $GITHUB_OUTPUT
            echo "verify=WHATSAPP_VERIFY_TOKEN_QA"                 >> $GITHUB_OUTPUT
            echo "access=WHATSAPP_ACCESS_TOKEN_QA"                 >> $GITHUB_OUTPUT
            echo "phone=WABA_PHONE_NUMBER_ID_QA"                   >> $GITHUB_OUTPUT
          else
            echo "service=cp-unified"                              >> $GITHUB_OUTPUT
            echo "verify=WHATSAPP_VERIFY_TOKEN_PROD"               >> $GITHUB_OUTPUT
            echo "access=WHATSAPP_ACCESS_TOKEN_PROD"               >> $GITHUB_OUTPUT
            echo "phone=WABA_PHONE_NUMBER_ID_PROD"                 >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy "${{ steps.cfg.outputs.service }}" \
            --image "$IMAGE" \
            --region "${{ env.REGION }}" \
            --service-account "wizbi-runner@${{ env.PROJECT_ID }}.iam.gserviceaccount.com" \
            --no-allow-unauthenticated \
            --set-env-vars "NODE_ENV=production" \
            --set-secrets="WHATSAPP_VERIFY_TOKEN=${{ steps.cfg.outputs.verify }}:latest,WHATSAPP_ACCESS_TOKEN=${{ steps.cfg.outputs.access }}:latest,WABA_PHONE_NUMBER_ID=${{ steps.cfg.outputs.phone }}:latest"

      - name: Print service URL
        run: |
          URL=$(gcloud run services describe "${{ steps.cfg.outputs.service }}" --region "${{ env.REGION }}" --format='value(status.url)')
          echo "Deployed: $URL"
