<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WizBI Control</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš€</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/admin/admin.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    // Load Firebase config dynamically â€” works on both Cloud Run and Firebase Hosting
    (async function () {
      try {
        // Try Firebase Hosting reserved URL first
        let res = await fetch('/__/firebase/init.json');
        if (!res.ok) throw new Error('Not on Firebase Hosting');
        const cfg = await res.json();
        firebase.initializeApp(cfg);
      } catch {
        // Fallback: fetch config from API (Cloud Run direct access)
        const res = await fetch('/api/firebase-config');
        const cfg = await res.json();
        firebase.initializeApp(cfg);
      }
      document.dispatchEvent(new Event('firebase-config-loaded'));
    })();
  </script>
</head>

<body>

  <div id="loginContainer" class="center-container">
    <div class="auth-box">
      <h1>WizBI Control</h1>
      <p>Please log in to manage your infrastructure.</p>
      <button id="btnLogin" class="login-button">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon">
        <span>Sign in with Google</span>
      </button>
    </div>
  </div>

  <div id="unauthorizedContainer" class="center-container hidden">
    <div class="auth-box">
      <h2>Access Denied</h2>
      <p>You are not authorized to view this page. Please contact support if you believe this is an error.</p>
      <button id="btnLogoutUnauthorized" class="btn btn-primary">Logout</button>
    </div>
  </div>

  <div id="adminPanelContainer" class="layout-container hidden">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>WizBI</h1>
      </div>
      <nav id="sidebarNav" class="sidebar-nav"></nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <span id="userEmail"></span>
          <button id="btnLogoutAdmin">Logout</button>
        </div>
        <button id="sidebarToggleDesktop" class="sidebar-toggle-desktop" title="Toggle Sidebar">
          <svg class="toggle-arrow" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7">
            </path>
          </svg>
        </button>
      </div>
    </aside>

    <div id="mobileOverlay" class="mobile-overlay"></div>

    <main class="main-content">
      <header class="mobile-header">
        <h1 class="logo">WizBI</h1>
        <button id="hamburgerButton" class="hamburger-button">
          <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </header>

      <div id="tabContentProjects" class="tab-content">
        <div class="global-links-bar">
          <div id="globalLinksContainer" class="global-links-container"></div>
          <button id="btnAddGlobalLink" class="btn btn-secondary btn-sm" title="Add Global Link">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
              </path>
            </svg>
            <span>Add Global Link</span>
          </button>
        </div>
        <div class="page-header">
          <h2>Projects</h2>
          <button id="btnShowProvisionProject" class="btn btn-primary">Provision New Project</button>
        </div>
        <div id="formProvisionProjectCard" class="card hidden">
          <h3>Provision New Project</h3>
          <form id="formProvisionProject" class="form-grid">
            <div class="form-group"><label for="projectOrgId">Organization</label><select id="projectOrgId"
                required></select></div>
            <div class="form-group">
              <label for="projectTemplate">Repository Template</label>
              <select id="projectTemplate" required>
              </select>
            </div>
            <div class="form-group"><label for="projectDisplayName">Display Name</label><input type="text"
                id="projectDisplayName" placeholder="e.g., Acme Website" required></div>
            <div class="form-group">
              <label for="projectShortName">Project Short Name</label>
              <input type="text" id="projectShortName" placeholder="e.g., acme-site" required pattern="^[a-z0-9-]{3,}$"
                title="Must be at least 3 characters of lowercase letters, numbers, and hyphens.">
            </div>
            <div class="form-group full-width">
              <label>Full Project ID (Auto-generated)</label>
              <input type="text" id="fullProjectIdPreview" readonly class="preview-field">
            </div>
            <button type="submit" class="btn btn-primary">Create Project</button>
          </form>
        </div>
        <div class="card">
          <div class="table-wrapper">
            <table id="projectsTable" class="data-table">
              <thead>
                <tr>
                  <th data-sortable="displayName">Display Name</th>
                  <th data-sortable="orgName">Organization</th>
                  <th data-sortable="id">Project ID</th>
                  <th data-sortable="state">Status</th>
                  <th>Links</th>
                  <th data-sortable="createdAt">Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabContentOrgs" class="tab-content hidden">
        <div class="page-header">
          <h2>Organizations</h2>
          <button id="btnShowCreateOrg" class="btn btn-primary">Create New Organization</button>
        </div>
        <div id="formCreateOrgCard" class="card hidden">
          <h3>Create New Organization</h3>
          <form id="formCreateOrg" class="form-grid">
            <div class="form-group"><label for="orgName">Organization Name</label><input type="text" id="orgName"
                placeholder="Organization Name" required></div>
            <button type="submit" class="btn btn-primary">Create</button>
          </form>
        </div>
        <div class="card">
          <div class="table-wrapper">
            <table id="orgsTable" class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>ID</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabContentTemplates" class="tab-content hidden">
        <div class="page-header">
          <h2>Template Management</h2>
          <button id="btnShowCreateTemplate" class="btn btn-primary">Create New Template</button>
        </div>

        <div id="formCreateTemplateCard" class="card hidden">
          <h3>Create New Template</h3>
          <form id="formCreateTemplate" class="form-grid">
            <div class="form-group">
              <label for="templateName">Template Name (e.g., "nextjs-blog")</label>
              <input type="text" id="templateName" placeholder="Short name, no spaces" required
                title="Must be at least 3 characters of lowercase letters, numbers, and hyphens.">
            </div>
            <div class="form-group">
              <label for="templateDescription">Description</label>
              <input type="text" id="templateDescription" placeholder="A brief description of the template" required>
            </div>
            <div class="form-group full-width">
              <label>Full Repository Name (Auto-generated)</label>
              <input type="text" id="fullTemplateNamePreview" readonly class="preview-field">
            </div>
            <p class="full-width" style="color: var(--text-secondary); font-size: 0.875rem;">This will create a new
              repository by cloning 'template-base' and mark it as a template on GitHub.</p>
            <button type="submit" class="btn btn-primary">Create Template</button>
          </form>
        </div>

        <div class="card">
          <div class="table-wrapper">
            <table id="templatesTable" class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Link</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabContentUsers" class="tab-content hidden">
        <div class="page-header">
          <h2>User Management</h2>
        </div>
        <div class="card">
          <div class="table-wrapper">
            <table id="usersTable" class="data-table">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Organizations</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tabContentSettings" class="tab-content hidden">
        <div class="page-header">
          <h2>Settings</h2>
          <button id="btnRefreshSecrets" class="btn btn-secondary">Refresh Status</button>
        </div>

        <!-- GitHub App Setup Wizard -->
        <div id="githubSetupCard" class="card"
          style="margin-bottom: 1.5rem; border: 2px solid var(--border-color); position: relative; overflow: hidden;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:1rem;">
            <svg viewBox="0 0 16 16" style="width:32px;height:32px;">
              <path fill="currentColor"
                d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
              </path>
            </svg>
            <div>
              <h3 style="margin:0;font-size:1.2rem;">GitHub App Integration</h3>
              <p style="margin:0;font-size:0.85rem;color:var(--text-secondary);">Connect a GitHub App to enable project
                provisioning, repo creation, and CI/CD.</p>
            </div>
          </div>

          <!-- Status: Loading -->
          <div id="ghSetupLoading" style="text-align:center;padding:1rem;color:var(--text-secondary);">
            <div class="spinner" style="display:inline-block;margin-bottom:0.5rem;"></div>
            <div>Checking GitHub connection...</div>
          </div>

          <!-- Status: Not Connected -->
          <div id="ghSetupNotConnected" class="hidden">
            <div style="background:var(--bg-secondary);border-radius:8px;padding:1.25rem;margin-bottom:1rem;">
              <p style="margin:0 0 1rem 0;font-size:0.9rem;line-height:1.5;">
                No GitHub App connected yet. Click below to automatically create and configure a GitHub App with the
                correct permissions.
                This takes about 30 seconds.
              </p>
              <button id="btnConnectGithub" class="btn btn-primary"
                style="display:flex;align-items:center;gap:8px;font-size:1rem;padding:10px 24px;">
                <svg viewBox="0 0 16 16" style="width:20px;height:20px;">
                  <path fill="currentColor"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                  </path>
                </svg>
                Connect GitHub App
              </button>
            </div>
          </div>

          <!-- Status: App Created, Not Yet Installed -->
          <div id="ghSetupCreated" class="hidden">
            <div style="display:flex;flex-direction:column;gap:1rem;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="color:var(--success-color);font-size:1.2rem;">âœ…</span>
                <span style="font-weight:600;">GitHub App created</span>
                <span id="ghSetupAppId" style="font-size:0.8rem;color:var(--text-secondary);"></span>
              </div>
              <div style="background:var(--bg-secondary);border-radius:8px;padding:1.25rem;">
                <p style="margin:0 0 1rem 0;font-size:0.9rem;line-height:1.5;">
                  <strong>Step 2:</strong> Install the app on your GitHub organization to grant it access to your
                  repositories.
                </p>
                <button id="btnInstallApp" class="btn btn-primary"
                  style="display:flex;align-items:center;gap:8px;font-size:1rem;padding:10px 24px;">
                  <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:20px;height:20px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                  </svg>
                  Install on Organization
                </button>
                <p style="margin:1rem 0 0 0;font-size:0.8rem;color:var(--text-secondary);">
                  After installing, the installation ID is captured automatically via webhook.
                  If it doesn't auto-detect, paste it manually below.
                </p>
                <div id="ghManualInstallation" style="display:flex;gap:8px;margin-top:0.5rem;">
                  <input type="text" id="ghInstallationIdInput" placeholder="Installation ID (optional fallback)"
                    style="flex:1;padding:6px 10px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-secondary);color:var(--text-primary);font-size:0.85rem;">
                  <button id="btnSaveInstallationId" class="btn btn-secondary btn-sm">Save</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Status: Fully Connected -->
          <div id="ghSetupConnected" class="hidden">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:0.5rem;">
              <span style="color:var(--success-color);font-size:1.2rem;">âœ…</span>
              <span style="font-weight:600;color:var(--success-color);">GitHub App fully connected</span>
            </div>
            <p id="ghSetupConnectedInfo" style="margin:0;font-size:0.85rem;color:var(--text-secondary);"></p>
          </div>
        </div>

        <!-- Secrets Status Banner -->
        <div id="secretsStatusBanner" class="card" style="display:none;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span id="secretsStatusIcon" style="font-size:1.5rem;"></span>
            <span id="secretsStatusText" style="font-weight:600;"></span>
          </div>
        </div>

        <!-- Manual Secrets (collapsed by default, expanded via "Advanced" toggle) -->
        <details style="margin-top:1rem;">
          <summary
            style="cursor:pointer;font-weight:600;font-size:0.95rem;color:var(--text-secondary);padding:0.5rem 0;">
            Advanced: Manual Secret Configuration
          </summary>
          <div id="secretsContainer" style="margin-top:0.5rem;">
            <div class="settings-loading" style="text-align:center;padding:2rem;color:var(--text-secondary);">Loading
              secrets status...</div>
          </div>
        </details>
      </div>

    </main>
  </div>

  <div id="userEditModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="userEditModalTitle">Edit User</h3>
        <button class="close-button" data-close="userEditModal">&times;</button>
      </div>
      <div class="modal-body">
        <form id="userEditForm">
          <input type="hidden" id="userEditUid">
          <div class="form-group"><label>Role</label>
            <div class="checkbox-item"><input type="checkbox" id="userEditSuperAdmin"><label
                for="userEditSuperAdmin">Super Admin</label></div>
          </div>
          <div class="form-group"><label>Organization Admin</label>
            <div id="userEditOrgs" class="checkbox-group"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-close="userEditModal">Cancel</button>
        <button type="submit" form="userEditForm" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="logsModal" class="modal-overlay hidden">
    <div class="modal-content modal-lg">
      <div class="modal-header">
        <h3 id="logsModalTitle">Logs</h3>
        <div>
          <button class="close-button" data-close="logsModal">&times;</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="logsModalContent"></div>
      </div>
    </div>
  </div>

  <div id="addLinkModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="addLinkModalTitle">Add New Link</h3>
        <button class="close-button" data-close="addLinkModal">&times;</button>
      </div>
      <form id="addLinkForm">
        <div class="modal-body">
          <input type="hidden" id="addLinkContextId">
          <div class="form-group">
            <label for="linkName">Link Name (Tooltip)</label>
            <input type="text" id="linkName" placeholder="e.g., Project Specification" required>
          </div>
          <div class="form-group">
            <label for="linkUrl">URL</label>
            <input type="url" id="linkUrl" placeholder="https://..." required>
          </div>
          <div class="form-group">
            <label>Icon</label>
            <div id="iconPicker" class="icon-picker"></div>
          </div>
          <div class="form-group">
            <label>Icon Color</label>
            <div class="color-picker">
              <input type="radio" id="color-default" name="linkColor" value="default" checked><label for="color-default"
                class="color-swatch default" title="Default"></label>
              <input type="radio" id="color-blue" name="linkColor" value="blue"><label for="color-blue"
                class="color-swatch blue" title="Blue"></label>
              <input type="radio" id="color-green" name="linkColor" value="green"><label for="color-green"
                class="color-swatch green" title="Green"></label>
              <input type="radio" id="color-yellow" name="linkColor" value="yellow"><label for="color-yellow"
                class="color-swatch yellow" title="Yellow"></label>
              <input type="radio" id="color-red" name="linkColor" value="red"><label for="color-red"
                class="color-swatch red" title="Red"></label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-close="addLinkModal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Link</button>
        </div>
      </form>
    </div>
  </div>
  <script src="/admin/admin.js"></script>
</body>

</html>